<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ç§‘æŠ€å¼º guo - Dashboard</title>
        <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
        <script type="text/javascript">
            function to_arr(text_or_array) {
                if (!Array.isArray(text_or_array)) {
                    text_or_array = [text_or_array];
                }
                return text_or_array;
            }
            function get_app_jump_url(url){
                if (url.indexOf('/')!=-1) {
                    return encodeURIComponent(url);
                }else{
                    return url;
                }
            }
            function refresh_msg(messages) {
                messages = to_arr(messages);
                $("#message tr:first").nextAll().remove();
                for (const message of messages) {
                    if (-1 != message.text.indexOf("login.xuexi.cn")) {
                        jump_url =
                            "jump.html?" + get_app_jump_url(message.text);

                        $("#message table tr:first").after(
                            "<tr>" +
                                "<td>" +
                                "<span>" +
                                message.timestamp +
                                "</span>" +
                                "</td>" +
                                "<td>" +
                                '<a target="_blank" href="' +
                                jump_url +
                                '">' +
                                jump_url +
                                "</a>" +
                                "</td>" +
                                "</tr>"
                        );
                    } else {
                        $("#message table tr:first").after(
                            "<tr>" +
                                "<td>" +
                                "<span>" +
                                message.timestamp +
                                "</span>" +
                                "</td>" +
                                "<td>" +
                                "<span>" +
                                message.text +
                                "</span>" +
                                "</td>" +
                                "</tr>"
                        );
                    }
                }
            }
            function refresh_qrimg(qrurls) {
                qrurls = to_arr(qrurls);
                $("#qrurl tr:first").nextAll().remove();
                for (const qrurl of qrurls) {
                    $("#qrurl tr:first").after(
                        "<tr>" +
                            "<td>" +
                            "<span>" +
                            qrurl.timestamp +
                            "</span>" +
                            "</td>" +
                            "<td>" +
                            '<img src="' +
                            qrurl.url +
                            '"/>' +
                            "</td>" +
                            "</tr>"
                    );
                }
            }
            function refresh_user_status(users_status) {
                users_status = to_arr(users_status);
                $("#user-status tr:first").nextAll().remove();
                for (const u_info of users_status) {
                    $("#user-status table").append(
                        "<tr>" +
                            "<td><button onclick=\"learn('" +
                            u_info.uid +
                            "')\">" +
                            JSON.stringify(u_info.uid) +
                            "</button></td>" +
                            "<td>" +
                            JSON.stringify(u_info.status) +
                            "</td>" +
                            "<td><button onclick=\"remove_cookie('" +
                            u_info.uid +
                            "')\">" +
                            "é€€å‡º" +
                            "</button></td>" +
                            "</tr>"
                    );
                }
            }

            function add_msg(messages) {
                messages = to_arr(messages);
                for (const message of messages) {
                    $("#message table").append(
                        "<tr><td>" + JSON.stringify(message) + "</td></tr>"
                    );
                }
            }
            function add_tips(messages) {
                messages = to_arr(messages);
                for (const message of messages) {
                    $("#tips table").append(
                        "<tr><td>" + JSON.stringify(message) + "</td></tr>"
                    );
                }
            }
            function learn(uid) {
                $.ajax({
                    type: "GET",
                    url: "/api/learn_by_uid/" + uid,
                    dataType: "JSON",
                    success: function (response) {
                        add_tips(response.data);
                    },
                });
                console.log(uid);
            }
            function remove_cookie(uid) {
                $.ajax({
                    type: "GET",
                    url: "/api/remove_cookie/" + uid,
                    dataType: "JSON",
                    success: function (response) {
                        add_msg(response.data);
                    },
                });
            }
            function update() {
                $.ajax({
                    type: "GET",
                    url: "/api/update",
                    dataType: "JSON",
                    success: function (response) {
                        refresh_msg(response.data);
                    },
                });
            }

            function add_user() {
                $.ajax({
                    type: "GET",
                    url: "/api/add",
                    dataType: "JSON",
                    success: function (response) {
                        add_tips(response.data);
                    },
                });
            }
            function check_now() {
                $.ajax({
                    type: "GET",
                    url: "/api/now",
                    dataType: "JSON",
                    success: function (response) {
                        $("#timestamp").text("æœåŠ¡å™¨æ—¶é—´: " + response.data);
                    },
                });
            }
            function list_users_status() {
                $.ajax({
                    type: "GET",
                    url: "/api/list_users_status_from_memory",
                    dataType: "JSON",
                    success: function (response) {
                        refresh_user_status(response.data);
                    },
                });
            }
            function refresh_all_cookies() {
                $.ajax({
                    type: "GET",
                    url: "/api/refresh_all_cookies",
                    dataType: "JSON",
                    success: function (response) {
                        refresh_user_status(response.data);
                    },
                });
            }
            function force_refresh_all_cookies() {
                $.ajax({
                    type: "GET",
                    url: "/api/force_refresh_all_cookies",
                    dataType: "JSON",
                    success: function (response) {
                        add_tips('å¼ºåˆ¶åˆ·æ–°ç”¨æˆ·çŠ¶æ€!!!')
                        refresh_user_status(response.data);
                    },
                });
            }
            function learn_all() {
                $.ajax({
                    type: "GET",
                    url: "/api/learn",
                    dataType: "JSON",
                    success: function (response) {
                        refresh_msg(response.data);
                    },
                });
            }

            function list_messages() {
                $.ajax({
                    type: "GET",
                    url: "/api/list_messages",
                    dataType: "JSON",
                    success: function (response) {
                        refresh_msg(response.data);
                    },
                });
            }
            function list_qrurls() {
                $.ajax({
                    type: "GET",
                    url: "/api/list_qrurls",
                    dataType: "JSON",
                    success: function (response) {
                        refresh_qrimg(response.data);
                    },
                });
            }

            $(document).ready(function () {
                add_tips("15ç§’è‡ªåŠ¨åˆ·æ–°çŠ¶æ€,è¯·å‹¿é•¿æœŸæ‰“å¼€æ­¤é¡µé¢");
                setInterval(() => {
                    list_users_status();
                    list_messages();
                    list_qrurls();
                    check_now();
                }, 1000);
                setTimeout(() => {
                    setInterval(() => {
                        refresh_all_cookies();
                    }, 15000);
                }, 15000);
            });
        </script>
        <style type="text/css">

            .main{
                        background-color: rgba(102, 146, 191, 0.44);
                        /*è¾¹æ¡†*/
                        border: solid 1px rgba(102, 146, 191, 0.68);
                        /*è¾¹è§’å¼§åº¦*/
                        border-radius: 10px;
                        /*é˜´å½±*/
                        -moz-box-shadow:2px 2px 5px #333333; 
                        -webkit-box-shadow:2px 2px 5px #333333; 
                        box-shadow: 7px 15px 30px #285a63;
            }
            body {
                min-width: 780px;
            }

            /*è¡¨æ ¼æ ·å¼*/
            table {
                width: 90%;
                background: #ccc;
                margin: 10px auto;
                border-collapse: collapse;
                /*border-collapse:collapseåˆå¹¶å†…å¤–è¾¹è·(å»é™¤è¡¨æ ¼å•å…ƒæ ¼é»˜è®¤çš„2ä¸ªåƒç´ å†…å¤–è¾¹è·*/
            }

            th,
            td {
                height: 25px;
                line-height: 25px;
                text-align: center;
                border: 1px solid #ccc;
            }

            th {
                background: #eee;
                font-weight: normal;
            }

            tr {
                background: #fff;
            }

            tr:hover {
                background: #cc0;
            }

            td a {
                color: #06f;
                text-decoration: none;
                text-align: left;
                display: block; /* width: 120px; */ /* height: 40px; */
                color: #1f1193;
                background-color: #b1272787;
                overflow: hidden; /*è‡ªåŠ¨éšè—æ–‡å­—*/
                text-overflow: ellipsis; /*æ–‡å­—éšè—åæ·»åŠ çœç•¥å·*/
            }

            td a:hover {
                color: #06f;
                text-decoration: underline;
                background-color: orangered;
            }

            button {
                /* æŒ‰é’®ç¾åŒ– */
                width: 270px;
                /* å®½åº¦ */
                height: 40px;
                /* é«˜åº¦ */
                border-width: 0px;
                /* è¾¹æ¡†å®½åº¦ */
                border-radius: 3px;
                /* è¾¹æ¡†åŠå¾„ */
                background: #1e90ff;
                /* èƒŒæ™¯é¢œè‰² */
                cursor: pointer;
                /* é¼ æ ‡ç§»å…¥æŒ‰é’®èŒƒå›´æ—¶å‡ºç°æ‰‹åŠ¿ */
                outline: none;
                /* ä¸æ˜¾ç¤ºè½®å»“çº¿ */
                font-family: Microsoft YaHei;
                /* è®¾ç½®å­—ä½“ */
                color: white;
                /* å­—ä½“é¢œè‰² */
                font-size: 17px;
                /* å­—ä½“å¤§å° */
            }

            .login-button:hover {
                /* é¼ æ ‡ç§»å…¥æŒ‰é’®èŒƒå›´æ—¶æ”¹å˜é¢œè‰² */
                background: #5599ff;
            }
        </style>
    </head>

    <body>

        <div id="console" >
            <div>
                <table>
                    <caption>
                        <h2> ğŸ‘‡ğŸ‘‡æ“ä½œå°ğŸ‘‡ğŸ‘‡</h2>    
                    </caption>
                    <tr>
                        <th>ä½¿ç”¨è¯´æ˜</th>
                        <th style="width: 300px">åŠŸèƒ½æŒ‰é’®</th>
                    </tr>
                    <tr>
                        <td>æ›´æ–°ä»£ç ä¸ºæœ€æ–°ç‰ˆæœ¬</td>
                        <td>
                            <button onclick="update();">æ›´æ–°ä»£ç </button>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            æ·»åŠ ä¸€ä¸ªç”¨æˆ·ï¼š
                            <br />
                            ç‚¹å‡»æŒ‰é’®ä¹‹åï¼Œç­‰å¾…å‡ ç§’
                            <br />
                            ä¸‹é¢ä¼šè‡ªåŠ¨åˆ·æ–°å‡ºäºŒç»´ç å’Œé“¾æ¥
                            <br />
                            æŒ‰ç…§æç¤ºæ“ä½œ
                            <br>
                            æ‰‹æœºç”¨æˆ·è¯·ç‚¹å‡»æœ€æ–°çš„é“¾æ¥ï¼Œè·³è½¬APPç™»å½•ï¼Œç”µè„‘ç‚¹äº†æ²¡æœ‰ç”¨
                            <br />
                            ç”µè„‘ç”¨æˆ·è¯·æ‰“å¼€å­¦ä¹ å¼ºå›½è½¯ä»¶ï¼Œæ‰«ä¸€æ‰«ç™»å½•ï¼Œå…¶ä»–è½¯ä»¶æ‰«äº†æ²¡æœ‰ç”¨
                        </td>
                        <td>
                            <button onclick="add_user();">æ·»åŠ ç”¨æˆ·</button>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            ç‚¹å‡»æŒ‰é’®è·å–ç¼“å­˜çš„ç”¨æˆ·çŠ¶æ€
                            <br />
                            é¡µé¢ä¼šè‡ªåŠ¨è·å–ã€åˆ·æ–°
                        </td>
                        <td>
                            <button onclick="list_users_status();">
                                åˆ—å‡ºç”¨æˆ·çŠ¶æ€
                            </button>
                        </td>
                    </tr>
    
                    <tr>
                        <td>
                            ç‚¹å‡»æŒ‰é’®å¼ºåˆ¶åˆ·æ–°ç”¨æˆ·çŠ¶æ€
                            <br />
                            é¡µé¢ä¼šè‡ªåŠ¨è·å–ã€åˆ·æ–°
                        </td>
                        <td>
                            <button onclick="force_refresh_all_cookies();">
                                å¼ºåˆ¶åˆ·æ–°ç”¨æˆ·çŠ¶æ€
                            </button>
                        </td>
                    </tr>
    
                   <tr>
                        <td>
                            ç‚¹å‡»æŒ‰é’®åˆ·æ–°ä¿¡æ¯ï¼Œä»¥è·å–ç™»å½•é“¾æ¥ï¼Œç™»å½•çŠ¶æ€ç­‰
                            <br />
                            é¡µé¢ä¼šè‡ªåŠ¨è·å–ã€åˆ·æ–°
                        </td>
                        <td>
                            <button onclick="list_messages();">è·å–æ–°æ¶ˆæ¯</button>
                        </td>
                    </tr> 
                    <tr>
                        <td>
                            ç‚¹å‡»æŒ‰é’®åˆ·æ–°äºŒç»´ç æ¶ˆæ¯
                            <br />
                            ä»¥è·å–æœ€æ–°ç™»å½•äºŒç»´ç ï¼Œ
                            <br />
                            ä¸ä¼šå‡ºç°æ–°çš„äºŒç»´ç 
                            <br />
                            é¡µé¢ä¼šè‡ªåŠ¨è·å–ã€åˆ·æ–°
                        </td>
                        <td>
                            <button onclick="list_qrurls();">è·å–äºŒç»´ç </button>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            ç‚¹å‡»æŒ‰é’®å¼€å§‹å­¦ä¹ æ‰€æœ‰
                            <br>
                            æ‚¨æœ€å¥½ç‚¹å‡»æ‚¨çš„UIDå¼€å§‹å­¦ä¹ 
                        </td>
                        <td>
                            <button onclick="learn_all();">å­¦ä¹ å…¨éƒ¨</button>
                        </td>
                    </tr>
                </table>
            </div>
            <!-- # æ–°çº¿ç¨‹æ— æ³•æ“æ§å†…å­˜æ•°æ®åº“ -->
            <div id="tips">
                <table>
                    <caption >
                        æç¤ºåŒº
                        <h2> ğŸ‘‡ğŸ‘‡æç¤ºåŒºğŸ‘‡ğŸ‘‡</h2>
                    </caption>
                    <tr>
                        <th>tips</th>
                    </tr>
                    <tr>
                        <td><span id="timestamp">-æœåŠ¡å™¨æ—¶é—´-</span></td>
                    </tr>
                </table>
            </div>
            <div id="user-status" style="background-color: #99c58370"  class='main'>
                <table>
                    <caption>
                        <h2> ğŸ‘‡ğŸ‘‡ç‚¹å‡»æ‚¨çš„UIDå¼€å§‹å­¦ä¹  </h2>
                    </caption>
                    <tr>
                        <th style="width: 300px">UID</th>
                        <th>STATUS</th>
                        <th>å–æ¶ˆç™»å½•</th>
                    </tr>
                </table>
            </div>
            <div id="message">
                <table>
                    <caption>
                        <h2>ğŸ‘‡ğŸ‘‡ğŸ‘‡ æ¶ˆæ¯åŒºåŸŸ ğŸ‘‡ğŸ‘‡ğŸ‘‡ </h2>
                      <h3> ç‚¹å‡»æ·»åŠ ç”¨æˆ·å°±ä¼šå‡ºç°é“¾æ¥ï¼Œè¦åœ¨æ‰‹æœºæµè§ˆå™¨ç‚¹å‡»æ‰ä¼šè·³è½¬</h3>
                    </caption>
                    <tr>
                        <th style="width: 300px">timestamp</th>
                        <th>message</th>
                    </tr>
                </table>
            </div>
            <div id="qrurl">
                <table>
                    <caption>
                       <h2> ğŸ‘‡ğŸ‘‡ğŸ‘‡äºŒç»´ç åŒºåŸŸğŸ‘‡ğŸ‘‡ğŸ‘‡ </h2> 
                       <h3>è¯·å¼€å­¦ä¹ å¼ºå›½ï¼Œä¸Šé¢æœç´¢æ å³è¾¹æ‰«ä¸€æ‰«ï¼Œå…¶ä»–è½¯ä»¶æ‰«äº†æ²¡æœ‰ç”¨</h3>
                       <h3>æ‰«äº†ä¹‹åå¡ä½äº†å¤šè¯•ä¸¤æ¬¡</h3>
                    </caption>
                    <tr>
                        <th style="width: 300px">timestamp</th>
                        <th>qrurl</th>
                    </tr>
                </table>
            </div>
        </div>
    </body>
</html>
